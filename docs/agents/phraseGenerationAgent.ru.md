# Агент генерации фраз

Данный агент генерирует sc-ссылку с текстом ответного сообщения, где названия sc-переменных заменяются на соответствующие строки содержимого константных sc-ссылок.
Этот агент вызывается в StandardMessageReplyAgent, чтобы создать ответную фразу по шаблону, вернуть ему свой результат и ответить на вопрос пользователя.

**Класс действий:**

`action_phrase_generation`


**Parameters:**

1. `replyMessageNode` является результатом работы StandardMessageReplyAgent;

2. `phraseLink` является sc-ссылкой с шаблоном текста для ответного сообщения.

3. `parametersNode` является sc-узлом, содержащим аргументы шаблона.

**Ход работы:**

* Агент пытается получить `templateNode`, который связан с `phraseLink` с помощью неролевого отношения `nrel_phrase_template`;

<img src="../images/phraseGenerationAgentStep1.png"></img>

* После этого PhraseGenerationAgent генерирует sc-ссылку по шаблону, используя `templateNode`, `parametersNode` и  `phraseLink`;
    * Обработка регулярных выражений из `phraseLink` с целью вывода названия переменных из находит;
    * Сопоставление типа регулярного выражения и названия переменной;
    * Обработка `templateNode` при помощи `parametersNode` с целью сопоставления переменной из `templateNode` со значением соответствующей ей константы;
    * Создание текста ответа посредством запуска обработчика для каждой переменной, константное значение которой найдено. Каждый обработчик соответствует    своему типу регулярного выражения;
* Язык, которому принадлежит sc-ссылка, зависит от языка, которому принадлежал `phraseLink`. Если sc-ссылка связан с `lang_ru` с помощью константной позитивной sc-дуги, проведенной от `lang_ru` к `phraseLink`, тогда агент тоже создаст такую же sc-дугу от `lang_ru` к `linkResult`. Если агент не находит язык файл sc-ссылки, то он не создает никакой sc-дуги;
* После успешного нахождения ответа агент создает в базе знаний структуру ответа, соответствующую найденным значениям;
* generateSemanticEquivalent
* Итоговая sc-ссылка связывается с `actionAddr` с помощью неролевого отношения `nrel_result`, PhraseGenerationAgent завершает свою работу.  

### Пример

Пример входной структуры:

<img src="../images/phraseGenerationAgentStep2.png"></img>

Пример выходной структуры:

<img src="../images/phraseGenerationAgentStep3.png"></img>

### Структура необрабатываемых элементов

Частным полем агента является `notSearchable` - вектор sc-адресов, находящихся в структуре `not_to_search_structure` из базы знаний. `notSearchable` используется при поиске значений переменных из `templateNode`, когда некоторые элементы, подходящие по описанию, не следует обрабатывать.

### Результат

Возможные результаты:
 
* `SC_RESULT_OK` - sc-ссылка с ответной фразой создан.
* `SC_RESULT_ERROR` - внутренняя ошибка, невозможно найти соответствующий шаблону фрагмент базы знаний.
* `SC_RESULT_ERROR_INVALID_PARAMS` - некорректные параметры действия.
